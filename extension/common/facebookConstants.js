import{handleConnectionIssue}from"./errorMessages";import ErrorUtil from"../utils/ErrorUtil";export const getUserFacebookDetails=(e,t=(()=>{}))=>{fetch("https://www.facebook.com/marketplace/you/selling?_rdc=1&_rdr").then((async o=>{if(o.url&&!o.url.includes("facebook.com/marketplace/you/selling"))return t({type:"failed",errorMessage:handleConnectionIssue("facebook.com")}),!0;const a=await o.text(),{id:r,email:s,username:n}=getFacebookUserInfo(a);return t({type:"success",message:e,id:r,email:s,username:n}),!0})).catch((e=>{t({type:"failed",errorMessage:handleConnectionIssue("facebook.com")}),ErrorUtil.capture(e)}))};const getFacebookUserInfo=e=>{let t="",o="",a="";return e&&e.length>0&&(t=(e.match(/"NAME"\s*:\s*"([^"]+)"/)||[])[1]||"",o=(e.match(/"USER_ID"\s*:\s*"([^"]{2,})"/i)||[])[1]||"",(e.match(/"token"\s*:\s*"([^"]{2,})"/i)||[])[1]||""),{email:"",username:t,id:o,uid:""}},makeDeleteRequest=async(e,t)=>{const o=new URLSearchParams;o.append("fb_api_req_friendly_name","CometMarketplaceForSaleItemDeleteMutation"),o.append("doc_id","3675485922533478"),o.append("variables",JSON.stringify({input:{batch_delete_variants:!0,for_sale_item_id:t.marketplaceItemID,referral_surface:null,surface:"MARKETPLACE_PAGE_SELLING",actor_id:t.facebookUserId,client_mutation_id:"1"}})),Object.entries(e).forEach((([e,[t]])=>{"fb_api_req_friendly_name"!==e&&"variables"!==e&&"doc_id"!==e&&o.append(e,t)}));const a=await fetch("https://www.facebook.com/api/graphql/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",accept:"*/*"},body:o}),r=await a.json();console.log("actionJson",r)};export const watchRequest=(e,t)=>{const o=a=>{if(a.url.includes("api/graphql/")){const{formData:r}=a.requestBody;r&&r.fb_api_req_friendly_name&&r.fb_api_req_friendly_name.length&&r.fb_api_req_friendly_name[0]===e&&(t(r),chrome.webRequest.onBeforeRequest.removeListener(o))}};return chrome.webRequest.onBeforeRequest.hasListener(o)||chrome.webRequest.onBeforeRequest.addListener(o,{urls:["https://www.facebook.com/*","https://web.facebook.com/*"]},["requestBody"])};const getFBListingDetailsFromText=e=>{console.log("getFBListingDetailsFromText",e)};